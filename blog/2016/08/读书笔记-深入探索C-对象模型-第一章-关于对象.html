<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>[读书笔记]深入探索C++ 对象模型 第一章 关于对象 | 鉴心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="阅读的目的在阅读《C++ primer》的时候，书里面写了各种各样的情况下，C++的处理方式。囫囵吞枣的记下后，也就不求甚解了。而C++在工作中的使用已经有了那么一段时间。但是对于C++的很多现象，却依旧是只知道是这样，却不知道为什么是这样。那么阅读这本同样是 Lippman的书籍，就是为了解惑，为什么C++会导致我们看到的现象，而不是其他情况。我希望，通过这么本书，能够解答我的一部分疑问。
序工">
<meta property="og:type" content="article">
<meta property="og:title" content="[读书笔记]深入探索C++ 对象模型 第一章 关于对象">
<meta property="og:url" content="http://yoursite.com/child/blog/2016/08/读书笔记-深入探索C-对象模型-第一章-关于对象.html">
<meta property="og:site_name" content="鉴心">
<meta property="og:description" content="阅读的目的在阅读《C++ primer》的时候，书里面写了各种各样的情况下，C++的处理方式。囫囵吞枣的记下后，也就不求甚解了。而C++在工作中的使用已经有了那么一段时间。但是对于C++的很多现象，却依旧是只知道是这样，却不知道为什么是这样。那么阅读这本同样是 Lippman的书籍，就是为了解惑，为什么C++会导致我们看到的现象，而不是其他情况。我希望，通过这么本书，能够解答我的一部分疑问。
序工">
<meta property="og:image" content="http://yoursite.com/child/img/20160807 inside C++ 0.jpg">
<meta property="og:image" content="http://yoursite.com/child/img/20160807 inside C++ 1.jpg">
<meta property="og:image" content="http://yoursite.com/child/img/20160807 inside C++ 2.jpg">
<meta property="og:updated_time" content="2016-10-16T06:35:48.488Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[读书笔记]深入探索C++ 对象模型 第一章 关于对象">
<meta name="twitter:description" content="阅读的目的在阅读《C++ primer》的时候，书里面写了各种各样的情况下，C++的处理方式。囫囵吞枣的记下后，也就不求甚解了。而C++在工作中的使用已经有了那么一段时间。但是对于C++的很多现象，却依旧是只知道是这样，却不知道为什么是这样。那么阅读这本同样是 Lippman的书籍，就是为了解惑，为什么C++会导致我们看到的现象，而不是其他情况。我希望，通过这么本书，能够解答我的一部分疑问。
序工">
<meta name="twitter:image" content="http://yoursite.com/child/img/20160807 inside C++ 0.jpg">
  
    <link rel="alternate" href="/atom.xml" title="鉴心" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">鉴心</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com/child"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-读书笔记-深入探索C-对象模型-第一章-关于对象" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2016/08/读书笔记-深入探索C-对象模型-第一章-关于对象.html" class="article-date">
  <time datetime="2016-08-07T03:14:03.000Z" itemprop="datePublished">2016-08-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/读书笔记/">读书笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      [读书笔记]深入探索C++ 对象模型 第一章 关于对象
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="阅读的目的"><a href="#阅读的目的" class="headerlink" title="阅读的目的"></a>阅读的目的</h1><p>在阅读《C++ primer》的时候，书里面写了各种各样的情况下，C++的处理方式。囫囵吞枣的记下后，也就不求甚解了。而C++在工作中的使用已经有了那么一段时间。但是对于C++的很多现象，却依旧是只知道是这样，却不知道为什么是这样。<br>那么阅读这本同样是 Lippman的书籍，就是为了解惑，为什么C++会导致我们看到的现象，而不是其他情况。<br>我希望，通过这么本书，能够解答我的一部分疑问。</p>
<h1 id="序"><a href="#序" class="headerlink" title="序"></a>序</h1><p>工作里常听到的对于C++的抱怨是C++的编译器为程序员做了太多的服务，导致很多情况不受控制。不像C,大部分都需要手动去执行，可以明确的知道，什么时候做了什么。<br>我想这部分抱怨一方面来源于对于C++的不熟悉，一方面又来源于C++的特性。那么当对C++怎么实现各种特性了解后，对于编译器的行为有了概念后，我相信我应该能够解答很多疑问了。<br>就像Lippman在本书贴出的一封信件一般<br><img src="/img/20160807 inside C++ 0.jpg" alt=""></p>
<p>他希望这本书是这些问题的解答。<br><a id="more"></a></p>
<h1 id="第一章：关于对象"><a href="#第一章：关于对象" class="headerlink" title="第一章：关于对象"></a>第一章：关于对象</h1><p>本章主要是对于对象模型的一个大概浏览，但是对多重继承和虚拟继承等情况没有太多的观察<br>C语言，数据和处理数据操作是分开声明的，语言本身没有支持数据和函数的关联性。由一组分布在各个以功能为导向的函数中的算法所驱动，它们的处理的是共同的外部数据。<br>C++的实现使用的是ADT<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">classPoint &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Point(<span class="keyword">float</span> x);</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">float</span> _x;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这种形式将数据和函数相关联，数据封装。<br>那么这样的数据封装有成本吗？没有<br>所有的Class只会生成出一个函数实体。data members则是直接包含在class object中与C的struct一致。<br>C++的布局和存储时间的额外负担是由virtual引起的：</p>
<blockquote>
<ul>
<li>virtual function机制 用来支持一个有效率的“执行期绑定”。 </li>
<li>virtual base class 用来实现“多次出现在继承体系中的base class,有一个单一而被共享的实体”。</li>
</ul>
</blockquote>
<p>此外，还有一些多重继承下的额外负担。</p>
<h1 id="C-的对象模型"><a href="#C-的对象模型" class="headerlink" title="C++的对象模型"></a>C++的对象模型</h1><p>C++中存在两种数据成员 static、nostatic，三种成员函数 static、nostatic、virtual。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">classPoint &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Point(<span class="keyword">float</span> xval);</div><div class="line">    <span class="keyword">virtual</span> ~Point();</div><div class="line">    <span class="function"><span class="keyword">float</span> <span class="title">x</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">    <span class="function">staticint <span class="title">PointCount</span><span class="params">()</span></span>;</div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="function"><span class="keyword">virtual</span> ostream&amp;</span></div><div class="line">    <span class="title">print</span><span class="params">(ostream &amp;os)</span> <span class="keyword">const</span>;</div><div class="line">    float_x;</div><div class="line">    staticint_point_count;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><img src="/img/20160807 inside C++ 1.jpg" alt=""></p>
<p>上图为C++的对象模型：</p>
<blockquote>
<ul>
<li>nostatic data members 被配置在每一个class object之内。</li>
<li>static data members 被存放在所有的class object之外。</li>
<li>staitic 和 nostatic function members存放在class object之外。</li>
<li>virtual functions以两个步骤支持：</li>
<li>①每一个class产生出一堆指向virtual functions 的指针，放在表格之中。也就是虚表。</li>
<li>②每一个class object被添加了一个指针，指向相关的virtual table。通常这个指针被称为vptr。vptr的设和重置由每一个classd constructor destructor 和 copy assignmemt运算符自动完成。每一个class所关联的type_info object用意支持runtiome tyoe identification，rtti也经由virtual table被指出来，通常是放在第一个slot处。</li>
</ul>
</blockquote>
<h2 id="加上继承"><a href="#加上继承" class="headerlink" title="加上继承"></a>加上继承</h2><p>c++支持单一继承、多重继承、虚拟继承。<br><img src="/img/20160807 inside C++ 2.jpg" alt=""></p>
<p>具体的讨论需要3.4中见到。</p>
<h2 id="对象模型如何影响程序"><a href="#对象模型如何影响程序" class="headerlink" title="对象模型如何影响程序"></a>对象模型如何影响程序</h2><p>class X定义了一个拷贝构造函数，一个虚析构函数，一个虚函数foo();<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">X <span class="title">foobar</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    X xx;</div><div class="line">    X *px = <span class="keyword">new</span> X;</div><div class="line">    xx.foo();</div><div class="line">    <span class="keyword">delete</span> px;</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个函数可能在内部转换为<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//可能的内部转换结果</span></div><div class="line"><span class="comment">//虚拟C++码</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foobar</span><span class="params">(X&amp; _result)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//使用引用返回，属于编译器的优化了。</span></div><div class="line">    <span class="comment">//构造</span></div><div class="line">    _result.X::X();</div><div class="line"></div><div class="line">    <span class="comment">//申请内存</span></div><div class="line">    px = _new(<span class="keyword">sizeof</span>(X));</div><div class="line">    <span class="comment">//调用构造函数</span></div><div class="line">    <span class="keyword">if</span>( px != <span class="number">0</span>)</div><div class="line">        px-&gt;X::X();</div><div class="line"></div><div class="line">    <span class="comment">//成员函数的形式的转换，成员函数就是普通函数不过有一个this指针</span></div><div class="line">    foo(&amp;_result);</div><div class="line"></div><div class="line">    <span class="comment">//虚函数的基本调用方式，通过vptr来调用</span></div><div class="line">    (*px-&gt;vtbl[<span class="number">2</span>])(px);</div><div class="line"></div><div class="line">    <span class="comment">//调用虚析构函数</span></div><div class="line">    <span class="keyword">if</span>( px != <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        (*px-&gt;vtbl[<span class="number">1</span>])(px);</div><div class="line">        _delete(px);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//不需要使用named return statement</span></div><div class="line">    <span class="comment">//不需要摧毁Local object xx</span></div><div class="line">    <span class="comment">//而是使用了传入参数_result</span></div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="关键词所带来的差异"><a href="#关键词所带来的差异" class="headerlink" title="关键词所带来的差异"></a>关键词所带来的差异</h1><h2 id="策略性正确的struct"><a href="#策略性正确的struct" class="headerlink" title="策略性正确的struct"></a>策略性正确的struct</h2><p>把单一元素的数组放在一个struct的尾端，于是每个 struct objects 可以拥有可变大小的数组：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> mumble &#123;</div><div class="line">    <span class="keyword">char</span> pc[<span class="number">1</span>];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//获取一个字符串，然后为struct本身和该字符串配置足够的内存</span></div><div class="line"><span class="keyword">struct</span> mumble *pmumbl = (<span class="keyword">struct</span> mumble*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span></div><div class="line">mumble) + <span class="built_in">strlen</span>(<span class="built_in">string</span>) + <span class="number">1</span>);</div><div class="line"><span class="built_in">strcpy</span>(pmumbl-&gt;pc, <span class="built_in">string</span>);</div></pre></td></tr></table></figure></p>
<p>这在C++中是很有问题的。不一定在pc后面就没有存放数据。</p>
<h1 id="对象的差异"><a href="#对象的差异" class="headerlink" title="对象的差异"></a>对象的差异</h1><p>C++支持多种程序设计典范：程序模型、抽象数据类型模型、面向对象模型</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/child//blog/2016/08/读书笔记-深入探索C-对象模型-第一章-关于对象.html" data-id="civke9iza0008e6karcd8j9ar" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/理论/">理论</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/读书笔记/">读书笔记</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2016/08/读书笔记-深入理解C-对象模型-第二章 构造函数的语意学.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          [读书笔记]深入理解C++对象模型 第二章 构造函数的语意学
        
      </div>
    </a>
  
  
    <a href="/blog/2016/08/读书笔记-《如何阅读一本书》.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">[读书笔记] 《如何阅读一本书》</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/开发环境/">开发环境</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/摘录/">摘录</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/游戏/">游戏</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PS4/">PS4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPG/">RPG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google/">google</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sicp/">sicp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stl源码剖析/">stl源码剖析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂书/">杂书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂谈/">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/游戏/">游戏</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/环境搭建/">环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/理论/">理论</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程规范/">编程规范</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算机程序的构造与解释/">计算机程序的构造与解释</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书笔记/">读书笔记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 16.67px;">C++</a> <a href="/tags/PS4/" style="font-size: 10px;">PS4</a> <a href="/tags/RPG/" style="font-size: 10px;">RPG</a> <a href="/tags/google/" style="font-size: 10px;">google</a> <a href="/tags/sicp/" style="font-size: 16.67px;">sicp</a> <a href="/tags/stl源码剖析/" style="font-size: 10px;">stl源码剖析</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/数据结构/" style="font-size: 10px;">数据结构</a> <a href="/tags/杂书/" style="font-size: 10px;">杂书</a> <a href="/tags/杂谈/" style="font-size: 13.33px;">杂谈</a> <a href="/tags/游戏/" style="font-size: 10px;">游戏</a> <a href="/tags/环境搭建/" style="font-size: 10px;">环境搭建</a> <a href="/tags/理论/" style="font-size: 16.67px;">理论</a> <a href="/tags/编程规范/" style="font-size: 10px;">编程规范</a> <a href="/tags/计算机程序的构造与解释/" style="font-size: 16.67px;">计算机程序的构造与解释</a> <a href="/tags/读书笔记/" style="font-size: 20px;">读书笔记</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2016/11/读书笔记-stl源码剖析 -第一章、第二章.html">[读书笔记] stl源码剖析 第一章、第二章</a>
          </li>
        
          <li>
            <a href="/blog/2016/11/阅读谷歌编程规范.html">阅读谷歌编程规范</a>
          </li>
        
          <li>
            <a href="/blog/2016/10/windows下Pyqt-guiqwt环境的搭建.html">windows下Pyqt + guiqwt环境的搭建</a>
          </li>
        
          <li>
            <a href="/blog/2016/09/读书笔记-sicp-第三章-模块化-对象和状态.html">[读书笔记] sicp 第三章 模块化 对象和状态</a>
          </li>
        
          <li>
            <a href="/blog/2016/09/读书笔记-sicp-第二章-带有通用型操作的系统.html">[读书笔记] sicp 第二章 带有通用型操作的系统</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 YangYi<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>