<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>curl - Tag - 鉴心</title>
        <link>http://coderyang.com/tags/curl/</link>
        <description>curl - Tag - 鉴心</description>
        <generator>Hugo -- gohugo.io</generator><language>en</language><copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Sat, 14 Nov 2020 16:04:59 &#43;0000</lastBuildDate><atom:link href="http://coderyang.com/tags/curl/" rel="self" type="application/rss+xml" /><item>
    <title>高性能libcurl</title>
    <link>http://coderyang.com/libcurl/</link>
    <pubDate>Sat, 14 Nov 2020 16:04:59 &#43;0000</pubDate>
    <author>Author</author>
    <guid>http://coderyang.com/libcurl/</guid>
    <description><![CDATA[<p>本文主要介绍一下curl接口的使用方法，以及获取高性能的一些实践。</p>
<h2 id="什么是libcurl用处">什么是libcurl？用处？</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">libcurl is a free and easy-to-use client-side URL transfer library, supporting DICT, FILE, FTP, FTPS, Gopher, HTTP, HTTPS, IMAP, IMAPS, LDAP, LDAPS, MQTT, POP3, POP3S, RTMP, RTMPS, RTSP, SCP, SFTP, SMTP, SMTPS, Telnet and TFTP. libcurl supports SSL certificates, HTTP POST, HTTP PUT, FTP uploading, HTTP form based upload, proxies, cookies, user+password authentication (Basic, Digest, NTLM, Negotiate, Kerberos), file transfer resume, http proxy tunneling and more!
</code></pre></td></tr></table>
</div>
</div><p>官网摘的一段，意思大概是免费且容易使用的url传输库，支持下面一堆特性。</p>
<p>项目内用处：基于libcurl实现了一个单线程异步的httpc，用于msdk、防沉迷、信用分等需要接入外部http的服务。</p>
<h2 id="接口介绍">接口介绍</h2>
<p>curl一共有三种接口：</p>
<ul>
<li><a href="https://curl.haxx.se/libcurl/c/libcurl-easy.html" target="_blank" rel="noopener noreffer">Easy Interface</a></li>
<li><a href="https://curl.haxx.se/libcurl/c/libcurl-multi.html" target="_blank" rel="noopener noreffer">Multi Interface</a></li>
<li><a href="https://curl.haxx.se/libcurl/c/libcurl-share.html" target="_blank" rel="noopener noreffer">Share Interface</a></li>
</ul>
<h3 id="easy-interface">Easy Interface</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">The easy interface is a synchronous, efficient, quickly used and... yes, easy interface for file transfers. Numerous applications have been built using this.
</code></pre></td></tr></table>
</div>
</div><p>简单接口是一个同步接口，非常方便使用，接口以curl_easy_开头，下面一个简单的使用例子。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">CURL</span> <span class="o">*</span><span class="n">curl</span> <span class="o">=</span> <span class="n">curl_easy_init</span><span class="p">();</span> <span class="c1">// 创建一个handle
</span><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">CURLcode</span> <span class="n">res</span><span class="p">;</span>
  <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">curl</span><span class="p">,</span> <span class="n">CURLOPT_URL</span><span class="p">,</span> <span class="s">&#34;https://example.com&#34;</span><span class="p">);</span> <span class="c1">// 设置参数，参数有很多，header、cookie、接收回调函数、证书等等
</span><span class="c1"></span>  <span class="n">res</span> <span class="o">=</span> <span class="n">curl_easy_perform</span><span class="p">(</span><span class="n">curl</span><span class="p">);</span> <span class="c1">// 执行，注意这里是阻塞的
</span><span class="c1"></span>  <span class="n">curl_easy_cleanup</span><span class="p">(</span><span class="n">curl</span><span class="p">);</span> <span class="c1">// 清理
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="multi-interface">Multi Interface</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">The multi interface is the asynchronous brother in the family and it also offers multiple transfers using a single thread and more. 
</code></pre></td></tr></table>
</div>
</div><p>多重接口是异步接口，libcurl使用一个或者多个线程完成数据传输，通过多重接口可以再单线程下同时操作多个easy handle。</p>
<p>例子：https://gist.github.com/clemensg/4960504</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#define MAX_WAIT_MSECS 30*1000 </span><span class="cm">/* Wait max. 30 seconds */</span><span class="cp">
</span><span class="cp"></span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">urls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">&#34;http://www.microsoft.com&#34;</span><span class="p">,</span>
  <span class="s">&#34;http://www.yahoo.com&#34;</span><span class="p">,</span>
  <span class="s">&#34;http://www.wikipedia.org&#34;</span><span class="p">,</span>
  <span class="s">&#34;http://slashdot.org&#34;</span>
<span class="p">};</span>
<span class="cp">#define CNT 4
</span><span class="cp"></span>
<span class="k">static</span> <span class="n">size_t</span> <span class="nf">cb</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">l</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* take care of the data here, ignored in this example */</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">d</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">n</span><span class="o">*</span><span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="n">CURLM</span> <span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">CURL</span> <span class="o">*</span><span class="n">eh</span> <span class="o">=</span> <span class="n">curl_easy_init</span><span class="p">();</span>
  <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">CURLOPT_WRITEFUNCTION</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
  <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">CURLOPT_HEADER</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
  <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">CURLOPT_URL</span><span class="p">,</span> <span class="n">urls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">CURLOPT_PRIVATE</span><span class="p">,</span> <span class="n">urls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">CURLOPT_VERBOSE</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
  <span class="n">curl_multi_add_handle</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">eh</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">CURLM</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="n">curl_multi_init</span><span class="p">();</span> <span class="c1">// 创建一个multi handle
</span><span class="c1"></span>
    <span class="c1">// 创建一堆easy handle加入到multi handle里
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CNT</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">init</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 执行，等待所有都执行完
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">still_running</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">curl_multi_perform</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">still_running</span><span class="p">);</span>
    <span class="k">do</span> <span class="p">{</span>
      	<span class="c1">// 等一段时间，MAX_WAIT_MSECS为最长时长
</span><span class="c1"></span>        <span class="c1">// 有事件或者超时了返回
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">curl_multi_wait</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_WAIT_MSECS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numfds</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">CURLM_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;error: curl_multi_wait() returned %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">curl_multi_perform</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">still_running</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">still_running</span><span class="p">);</span>

    <span class="c1">// 读取数据
</span><span class="c1"></span>    <span class="n">CURLMsg</span> <span class="o">*</span><span class="n">msg</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">szUrl</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">msgs_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">http_status_code</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">msg</span> <span class="o">=</span> <span class="n">curl_multi_info_read</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgs_left</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">==</span> <span class="n">CURLMSG_DONE</span><span class="p">)</span> <span class="p">{</span>
    		<span class="n">CURL</span> <span class="o">*</span><span class="n">eh</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">easy_handle</span><span class="p">;</span>
            <span class="n">CURLcode</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">result</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">return_code</span><span class="o">!=</span><span class="n">CURLE_OK</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;CURL error code: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">result</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// Get HTTP status code
</span><span class="c1"></span>            <span class="n">http_status_code</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">szUrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">curl_easy_getinfo</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">CURLINFO_RESPONSE_CODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">http_status_code</span><span class="p">);</span>
            <span class="n">curl_easy_getinfo</span><span class="p">(</span><span class="n">eh</span><span class="p">,</span> <span class="n">CURLINFO_PRIVATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">szUrl</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">http_status_code</span><span class="o">==</span><span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;200 OK for %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">szUrl</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;GET of %s returned http status code %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">szUrl</span><span class="p">,</span> <span class="n">http_status_code</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">curl_multi_remove_handle</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">eh</span><span class="p">);</span>
            <span class="n">curl_easy_cleanup</span><span class="p">(</span><span class="n">eh</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;error: after curl_multi_info_read(), CURLMsg=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 关闭
</span><span class="c1"></span>    <span class="n">curl_multi_cleanup</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="share-interface">Share Interface</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">The share interface was added to enable sharing of data between curl &#34;handles&#34;.
</code></pre></td></tr></table>
</div>
</div><p>用于再多个easy handle共享一些数据，比如dns cache、tls session。</p>
<h3 id="其他">其他</h3>
<p>curl_global_init：进程启动时初始化curl</p>
<p>curl_global_cleanup：进程关闭时清理curl</p>
<p>使用异步DNS，防止同步解析DNS卡住主循环</p>
<h2 id="实践">实践</h2>
<ol>
<li>
<p>最初实现了一个使用Multi Interface的HTTPC。</p>
<ul>
<li>
<p>httpc/unittest/httpc.cpp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">TEST_F</span><span class="p">(</span><span class="n">HTTPC_TEST</span><span class="p">,</span> <span class="n">HTTP_GET</span><span class="p">)</span>                                                 
<span class="p">{</span>
    <span class="n">HTTPC_CFG</span> <span class="n">cfg</span><span class="p">;</span>
    <span class="n">REQUEST_DRIVER</span> <span class="nf">driver</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">HTTPC</span> <span class="nf">c</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">driver</span><span class="p">);</span>
         
    <span class="k">auto</span> <span class="n">cb</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">RESPONSE</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;result:%d code:%ld </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">rsp</span><span class="p">.</span><span class="n">_result</span><span class="p">,</span> <span class="n">rsp</span><span class="p">.</span><span class="n">_http_status_code</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;body:%s&#34;</span><span class="p">,</span> <span class="n">rsp</span><span class="p">.</span><span class="n">_body</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">};</span>
     
    <span class="k">for</span> <span class="p">(</span><span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#34;http://www.baidu.com&#34;</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
    <span class="p">}</span>
     
    <span class="kt">bool</span> <span class="n">idle</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">.</span><span class="n">_ctx_map</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">driver</span><span class="p">.</span><span class="n">loop</span><span class="p">(</span><span class="n">idle</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>在压测过程中发现性能不足，DNS解析卡住主循环。根据https://moz.com/devblog/high-performance-libcurl-tips，增加了c-ares库，使得libcurl支持异步DNS，最终性能到了3000TPS。</p>
</li>
<li>
<p>尝试使用Share Interface共享DNS，效果在接入异步DNS后不明显。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// 初始化共享
</span><span class="c1"></span><span class="n">pthread_mutex_t</span> <span class="n">_dns_lock</span> <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span>
<span class="n">CURLSH</span><span class="o">*</span> <span class="n">_share_handler</span> <span class="o">=</span> <span class="n">curl_share_init</span><span class="p">();</span>
<span class="n">curl_share_setopt</span><span class="p">(</span><span class="n">_share_handler</span><span class="p">,</span> <span class="n">CURLSHOPT_USERDATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_dns_lock</span><span class="p">);</span>
<span class="n">curl_share_setopt</span><span class="p">(</span><span class="n">_share_handler</span><span class="p">,</span> <span class="n">CURLSHOPT_LOCKFUNC</span><span class="p">,</span> <span class="n">_lock</span><span class="p">);</span>
<span class="n">curl_share_setopt</span><span class="p">(</span><span class="n">_share_handler</span><span class="p">,</span> <span class="n">CURLSHOPT_UNLOCKFUNC</span><span class="p">,</span> <span class="n">_unlock</span><span class="p">);</span>
<span class="n">curl_share_setopt</span><span class="p">(</span><span class="n">_share_handler</span><span class="p">,</span> <span class="n">CURLSHOPT_SHARE</span><span class="p">,</span> <span class="n">CURL_LOCK_DATA_DNS</span><span class="p">);</span>
   
<span class="c1">// 设置共享
</span><span class="c1"></span><span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">_requst</span><span class="o">-&gt;</span><span class="n">_curl_handle</span><span class="p">,</span> <span class="n">CURLOPT_SHARE</span><span class="p">,</span> <span class="n">_share_handler</span><span class="p">);</span>
<span class="n">curl_easy_setopt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">_requst</span><span class="o">-&gt;</span><span class="n">_curl_handle</span><span class="p">,</span> <span class="n">CURLOPT_DNS_CACHE_TIMEOUT</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">);</span><span class="c1">//5min
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>请求处理完毕后，不适用curl_easy_cleanup，而是采用连接池的方式通过curl_easy_reset重用连接。</p>
<ul>
<li>
<p><a href="https://curl.se/libcurl/c/libcurl-tutorial.html#Persistence">https://curl.se/libcurl/c/libcurl-tutorial.html#Persistence</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Re-cycling the same easy handle several times when doing multiple requests is the way to go.
     
After each single curl_easy_perform operation, libcurl will keep the connection alive and open. A subsequent request using the same easy handle to the same host might just be able to use the already open connection! This reduces network impact a lot.
     
Even if the connection is dropped, all connections involving SSL to the same host again, will benefit from libcurl&#39;s session ID cache that drastically reduces re-connection time.
     
....
     
libcurl caches DNS name resolving results, to make lookups of a previously looked up name a lot faster.
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><a href="https://curl.se/libcurl/c/curl_easy_reset.html">https://curl.se/libcurl/c/curl_easy_reset.html</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Re-initializes all options previously set on a specified CURL handle to the default values. This puts back the handle to the same state as it was in when it was just created with curl_easy_init.
     
It does not change the following information kept in the handle: live connections, the Session ID cache, the DNS cache, the cookies, the shares or the alt-svc cache.
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
]]></description>
</item></channel>
</rss>
